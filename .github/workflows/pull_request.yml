# Copyright (c) the JPEG XL Project Authors. All rights reserved.
#
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

# Workflow to run pull-requests specific checks.

name: PR
on:
  pull_request:
    types: [opened, reopened, synchronize]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Run source tests: author list, copyright notice and merge conflicts.
  authors:
    runs-on: [ubuntu-latest]
    steps:
    - name: Checkout the source
      uses: actions/checkout@v4
    - name: Check AUTHORS file
      run:
        ./ci/pull_request_checks.sh

  format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install latest rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt


      - name: Cargo fmt (check)
        run: cargo fmt --all -- --check

  clippy:
    runs-on: ${{ matrix.os || 'ubuntu-latest' }}
    strategy:
      fail-fast: false
      matrix:
        features: [all, none]
        os: [ubuntu-24.04-arm, ubuntu-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install latest rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2.8.0
        with:
          prefix-key: ${{ matrix.os }}-clippy-${{ matrix.features }}


      - name: Clippy with all features
        if: ${{ matrix.check == 'clippy' && matrix.features == 'all' }}
        run: cargo clippy --release --all-targets --all-features --tests --all -- -D warnings

      - name: Clippy with no features
        if: ${{ matrix.check == 'clippy' && matrix.features == 'none' }}
        run: cargo clippy --release --all-targets --no-default-features --tests --all -- -D warnings

  test:
    runs-on: ${{ matrix.os || 'ubuntu-latest' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04-arm, ubuntu-latest]
        simd: [none]
        include:
          - os: ubuntu-latest
            simd: sse42
          - os: ubuntu-latest
            simd: avx
          - os: ubuntu-latest
            simd: avx512
          - os: ubuntu-24.04-arm
            simd: neon
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install latest rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2.8.0
        with:
          prefix-key: ${{ matrix.os }}-test-${{ matrix.simd }}


      - name: Tests with SIMD feature ${{ matrix.simd }}
        if: ${{ matrix.simd != 'none' }}
        run: cargo test --release --all --no-fail-fast --no-default-features --features ${{ matrix.simd }}

      - name: Tests with no features
        if: ${{ matrix.simd == 'none' }}
        run: cargo test --release --all --no-fail-fast --no-default-features

  coverage:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the source
      uses: actions/checkout@v4

    - name: Install latest rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Rust cache
      uses: Swatinem/rust-cache@v2.7.3

    - name: Install llvm-cov
      run: cargo +stable install cargo-llvm-cov --locked

    - name: Build and gather coverage
      run: cargo llvm-cov --no-report --release

    - name: Generate JSON report
      run: cargo llvm-cov report --json --release --output-path=coverage.json

    - name: Distill summary
      run: ./ci/coverage_summary.py >> $GITHUB_STEP_SUMMARY

    - name: Generate HTML report
      run: cargo llvm-cov report --html --release --output-dir=coverage_html

    - name: Upload HTML report
      uses: actions/upload-artifact@v4.6.2
      with:
        name: coverage_report
        path: ./coverage_html/html

  conformance:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the source
      uses: actions/checkout@v4

    - name: Checkout bench
      uses: actions/checkout@master
      with:
        repository: libjxl/bench
        path: bench      
        fetch-depth: 1

    - name: Fix bench dependencies
      run: |
        ( cd bench && git submodule update --recursive --init --depth 1 --recommend-shallow third_party/conformance )
        ( cd bench/third_party && rm -rf jxl-rs && ln -s "${GITHUB_WORKSPACE}" jxl-rs )

    - name: Cache conformance objects
      id: cache-conformance
      uses: actions/cache@v4
      with:
        path: bench/third_party/conformance/.objects
        key: conformance-objects

    - name: Update conformance objects
      run: bash bench/third_party/conformance/scripts/download_and_symlink_using_curl.sh

    - name: Install latest rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt

    - name: Rust cache
      uses: Swatinem/rust-cache@v2.7.3

    - name: Build jxl_cli
      run: cargo build --release --bin jxl_cli

    - name: Setup python3
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Install Python dependencies
      run: pip install numpy apng pypng

    - name: Install binary dependencies
      run: sudo apt install imagemagick

    - name: Run jxl-rs conformance tests with ICC
      id: icc_conformance
      run: python3 ./bench/third_party/conformance/scripts/conformance.py --decoder "python3 ${GITHUB_WORKSPACE}/bench/scripts/wrap_jxl-rs.py --decoder ' ${GITHUB_WORKSPACE}/bench/third_party/jxl-rs/target/release/jxl_cli %s %s --icc-out %s'" --corpus ${GITHUB_WORKSPACE}/bench/third_party/conformance/testcases/main_level5.txt --results=${GITHUB_WORKSPACE}/bench/docs/dumps/dump_jxl-rs.json --lax

    - name: Run jxl-rs conformance tests wrapped in PNG
      id: png_conformance
      run: python3 ./bench/third_party/conformance/scripts/conformance.py --decoder "python3 ${GITHUB_WORKSPACE}/bench/scripts/wrap_png.py --decoder ' ${GITHUB_WORKSPACE}/bench/third_party/jxl-rs/target/release/jxl_cli --override-bitdepth=16 %s %s '" --corpus ${GITHUB_WORKSPACE}/bench/third_party/conformance/testcases/main_level5.txt --results=${GITHUB_WORKSPACE}/bench/docs/dumps/dump_jxl-rs_via_png.json --lax
      continue-on-error: true

    - name: Export step summary
      run: ./ci/conformance_summary.py "${GITHUB_WORKSPACE}/bench/docs/dumps/dump_jxl-rs.json" "${GITHUB_WORKSPACE}/bench/docs/dumps/dump_jxl-rs_via_png.json" >> $GITHUB_STEP_SUMMARY

    - name: Merge conformance report HTML
      run: ./ci/merge_conformance_report.py "${GITHUB_WORKSPACE}/bench/docs" >> conformance_report.html

    - name: Upload HTML report
      uses: actions/upload-artifact@v4.6.2
      with:
        name: conformance_report
        path: conformance_report.html

  benchmark:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
    - name: Checkout the source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history needed for jxl-perfhistory

    - name: Install latest rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Rust cache
      uses: Swatinem/rust-cache@v2.7.3
      with:
        prefix-key: benchmark

    - name: Install jxl-perfhistory
      run: cargo install --git https://github.com/zond/jxl-perfhistory

    - name: Select a few test images
      id: select-images
      run: |
        mkdir testimages
        cp jxl/resources/test/conformance_test_images/cafe.jxl testimages
        cp jxl/resources/test/conformance_test_images/bike.jxl testimages

    - name: Cache benchmark binaries
      uses: actions/cache@v4
      with:
        path: benchmark-binaries
        key: ${{ runner.os }}-${{ runner.arch }}-benchmark-binaries

    - name: Run performance benchmark
      id: benchmark
      continue-on-error: true  # Never fail the PR
      run: |
        jxl-perfhistory -r 5 -b benchmark-binaries -g "testimages/*.jxl" -c 0.99 -e 0.03 --ignore-noisy-system 2>&1 | tee benchmark.txt
        # Extract just the results section for the comment
        echo "BENCHMARK_OUTPUT<<EOF" >> $GITHUB_OUTPUT
        cat benchmark.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Post benchmark results as PR comment
      uses: peter-evans/create-or-update-comment@v4
      if: always()
      with:
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ## ðŸ“Š Performance Benchmark (bike 2048x2560)

          ```
          ${{ steps.benchmark.outputs.BENCHMARK_OUTPUT }}
          ```

          <sub>Generated by [jxl-perfhistory](https://github.com/zond/jxl-perfhistory)</sub>

    - name: Add to step summary
      if: always()
      run: |
        echo "## Performance Benchmark" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat benchmark.txt >> $GITHUB_STEP_SUMMARY || echo "Benchmark did not complete" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload benchmark results
      if: always()
      uses: actions/upload-artifact@v4.6.2
      with:
        name: benchmark_results
        path: benchmark.txt
        if-no-files-found: ignore
